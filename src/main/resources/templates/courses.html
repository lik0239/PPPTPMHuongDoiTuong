<!doctype html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <title>Học phần - ĐKHP</title>
  <link rel="stylesheet" href="/styles.css"/>
</head>

<body th:replace="~{_layout :: layout (~{::section}, ~{::title})}">
<section>
  <h1>Lớp học phần</h1>

  <!-- ADMIN: thêm học phần -->
  <div class="mb-2" sec:authorize="hasAuthority('ADMIN')">
    <a class="btn" th:href="@{/admin/courses/create}">+ Thêm học phần</a>
  </div>

  <!-- Flash -->
  <div th:if="${ok}"  class="alert alert-success" th:text="${ok}"></div>
  <div th:if="${err}" class="alert alert-danger"  th:text="${err}"></div>

  <!-- Toolbar tìm kiếm -->
  <form method="get" th:action="@{/courses}" class="toolbar toolbar-courses">
    <input type="text" name="q" th:value="${q}" placeholder="Tìm mã HP, tên HP, giảng viên, nhóm..."/>
    <button class="btn" type="submit">Tìm</button>
    <a class="btn" th:href="@{/courses(open=true, q=${q})}">Đang mở đăng ký</a>
  </form>

  <p class="muted" th:text="'Tìm thấy ' + ${count} + ' lớp.'">Tìm thấy 0 lớp.</p>

  <table class="table">
    <thead>
    <tr>
      <th>Mã HP</th>
      <th>Tên học phần</th>
      <th>TC</th>
      <th>Nhóm</th>
      <th>Giảng viên</th>
      <th>Lịch học</th>
      <th>Sĩ số</th>
      <th>Đã ĐK</th>
      <th>Thao tác</th>
    </tr>
    </thead>
    <tbody>
    <tr th:if="${#lists.isEmpty(items)}">
      <td colspan="9" class="muted">Không có dữ liệu.</td>
    </tr>

    <tr th:each="it : ${items}">
      <td th:text="${it.code}">CS101</td>
      <td th:text="${it.name}">Lập trình cơ bản</td>
      <td th:text="${it.credits}">3</td>
      <td th:text="${it.groupCode}">N01</td>
      <td th:text="${it.teacher}">(Đang cập nhật)</td>
      <td th:text="${it.schedule}">Th2 07:30-09:05</td>

      <!-- capacity hoặc enrolled có thể null: hiển thị an toàn -->
      <td th:text="${it.capacity} ?: '-'">60</td>
      <td th:text="${it.enrolled} ?: 0">42</td>

      <td>
        <!-- ====== KHU SV: Đăng ký / Hủy ====== -->
        <div sec:authorize="hasAuthority('STUDENT')">
          <!-- Form đăng ký (ẩn) -->
          <form th:id="${'reg' + it.classId}"
                th:if="${!#lists.contains(registeredIds, it.classId)
                        and (it.capacity == null or (it.enrolled ?: 0) < it.capacity)}"
                th:action="@{|/courses/${it.classId}/register|}"
                method="post" style="display:none">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
          </form>

          <!-- Nút đăng ký -->
          <button th:if="${!#lists.contains(registeredIds, it.classId)
                          and (it.capacity == null or (it.enrolled ?: 0) < it.capacity)}"
                  type="submit" class="btn" th:form="${'reg' + it.classId}">
            Đăng ký
          </button>

          <!-- Form hủy (ẩn) -->
          <form th:id="${'unreg' + it.classId}"
                th:if="${#lists.contains(registeredIds, it.classId)}"
                th:action="@{|/courses/${it.classId}/unregister|}"
                method="post" style="display:none">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
          </form>

          <!-- Nút hủy -->
          <button th:if="${#lists.contains(registeredIds, it.classId)}"
                  type="submit" class="btn btn-outline"
                  th:form="${'unreg' + it.classId}">
            Hủy đăng ký
          </button>

          <!-- Hết chỗ -->
          <span class="badge"
                th:if="${!#lists.contains(registeredIds, it.classId)
                        and it.capacity != null and (it.enrolled ?: 0) >= it.capacity}">
            Đã đủ
          </span>
        </div>

        <!-- ====== KHU ADMIN: Sửa / Xóa ====== -->
        <div sec:authorize="hasAuthority('ADMIN')">
          <a class="btn" th:href="@{|/admin/courses/${it.classId}/edit|}">Sửa</a>

          <form th:action="@{|/admin/courses/${it.classId}/delete|}"
                method="post" style="display:inline">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button class="btn btn-danger" type="submit"
                    onclick="return confirm('Xóa học phần này?')">
              Xóa
            </button>
          </form>
        </div>
      </td>
    </tr>
    </tbody>
  </table>
</section>
</body>
</html>
